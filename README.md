–¢–ó: Telegram-–±–æ—Ç ¬´–ü—è—Ç—é–Ω—è¬ª

–ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–°–æ—Ü–∏–∞–ª—å–Ω—ã–π –±–æ—Ç ¬´–º–∏—Ä–Ω–∞—è —ç—Å—Ç–∞—Ñ–µ—Ç–∞ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π¬ª. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥–∞—é—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –ø—è—Ç—é–Ω—é, —Å–æ–∑–¥–∞–≤–∞—è –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ —Å–≤—è–∑–µ–π. –ë–æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≥–µ–æ–≥—Ä–∞—Ñ–∏—é –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ –ø—è—Ç—é–Ω–∏. –¶–µ–ª—å ‚Äî –ø—Ä–æ–π—Ç–∏ 40075 –∫–º (—ç–∫–≤–∞—Ç–æ—Ä) –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Å—Ç–∞—Ä—Ç—É.

–°—Ç–µ–∫

Python 3.11+, aiogram 3.x, SQLAlchemy 2.0 async, PostgreSQL, Redis, TaskIQ, Alembic, Geopy+Nominatim, Loguru, Sentry, Docker Compose.

–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

CREATE TABLE users (
    id BIGINT PRIMARY KEY,  -- Telegram ID
    username VARCHAR(64),
    first_name VARCHAR(128),
    language_code VARCHAR(5) DEFAULT 'en',
    parent_id BIGINT REFERENCES users(id),
    distance_to_parent FLOAT DEFAULT 0,
    lat FLOAT,
    lon FLOAT,
    country_code VARCHAR(3),
    received_fives INTEGER DEFAULT 0,
    given_fives INTEGER DEFAULT 0,
    total_donated INTEGER DEFAULT 0,
    notifications_enabled BOOLEAN DEFAULT TRUE,
    is_blocked BOOLEAN DEFAULT FALSE,
    last_activity TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE fives_log (
    id SERIAL PRIMARY KEY,
    from_user_id BIGINT REFERENCES users(id),
    to_user_id BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW()
);


–ò–Ω–¥–µ–∫—Å—ã: parent_id, country_code, notifications_enabled, is_blocked, fives_log(to_user_id, from_user_id).

–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

/start –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚Äî –æ—Ç–∫–∞–∑ —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–Ω–≤–∞–π—Ç. –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ADMIN_ID —Å–æ–∑–¥–∞—ë—Ç –∫–æ—Ä–µ–Ω—å.

/start {ref_id}: –µ—Å–ª–∏ —é–∑–µ—Ä –Ω–æ–≤—ã–π ‚Äî —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, parent_id=ref_id, –∑–∞–ø—Ä–æ—Å –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏. –ï—Å–ª–∏ —é–∑–µ—Ä —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Äî –ø–æ–ª—É—á–∞–µ—Ç –ø—è—Ç—é–Ω—é, received_fives+=1, –¥–µ—Ä–µ–≤–æ –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è.

–ë–µ–∑ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø, distance=0, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏.

–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: —Ñ–æ—Ä–º—É–ª–∞ –ì–∞–≤–µ—Ä—Å–∏–Ω—É—Å–∞.

–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é

[‚úã –ü–µ—Ä–µ–¥–∞—Ç—å –ü—è—Ç—é–Ω—é] [üîç –ì–¥–µ –ü—è—Ç—é–Ω—è?]
[üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥—ã] [‚≠ê –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å]
[üåê –Ø–∑—ã–∫]


–ö–æ–º–∞–Ω–¥–∞ ¬´–ì–¥–µ –ü—è—Ç—é–Ω—è?¬ª

–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å + —Ç—Ä–µ–∫–∏–Ω–≥. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç: —Ç–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø—è—Ç—é–Ω–∏ (–∫–æ–Ω–µ—Ü —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π –≤–µ—Ç–∫–∏), –ø—É—Ç—å (–ø–µ—Ä–≤—ã–µ 2 + –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å –∏–º–µ–Ω–∞–º–∏ –∏ –≥–æ—Ä–æ–¥–∞–º–∏), –ø—Ä–æ—Ñ–∏–ª—å —é–∑–µ—Ä–∞ (—É—Ä–æ–≤–µ–Ω—å, –¥–∞–ª/–ø–æ–ª—É—á–∏–ª –ø—è—Ç—é–Ω—å, —Ä–∞–∑–º–µ—Ä –≤–µ—Ç–∫–∏), –≥–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä.

–ö—ç—à Redis 1 —á–∞—Å. –¢–∏—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: Tier1 (–Ω–æ–≤–∏—á–æ–∫ <7 –¥–Ω–µ–π) ‚Äî –∫–∞–∂–¥—ã–π —á–∞—Å; Tier2 (–≤–µ—Ç–∫–∞ 6+ —É—Ä–æ–≤–Ω–µ–π) ‚Äî –∫–∞–∂–¥—ã–π —á–∞—Å; Tier3 (–Ω–µ–∞–∫—Ç–∏–≤–µ–Ω >3 –¥–Ω–µ–π) ‚Äî –ø–æ –∑–∞–ø—Ä–æ—Å—É, –æ—Ç–≤–µ—Ç –æ—Ç–ª–æ–∂–µ–Ω–Ω—ã–π –¥–æ —á–∞—Å–∞.

–°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π

–£—Ä–æ–≤–µ–Ω—å —Ä–∞—Å—Ç—ë—Ç –æ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –ø—è—Ç—é–Ω—å (received_fives):

1 ‚Äî –ù–æ–≤–∏—á–æ–∫, 2 ‚Äî –î—É—à–∞ –∫–æ–º–ø–∞–Ω–∏–∏, 3 ‚Äî –ú–∞–≥–Ω–∏—Ç –¥—Ä—É–∑–µ–π, 5 ‚Äî –ù–∞—Ä–æ–¥–Ω—ã–π –ª—é–±–∏–º–µ—Ü, 10 ‚Äî –õ–µ–≥–µ–Ω–¥–∞, 25 ‚Äî –ê–º–±–∞—Å—Å–∞–¥–æ—Ä –º–∏—Ä–∞, 50 ‚Äî –•—Ä–∞–Ω–∏—Ç–µ–ª—å –ø—è—Ç—é–Ω–∏, 100 ‚Äî –ò–∫–æ–Ω–∞.

–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ –ø–æ—Ä–æ–≥–∞ ‚Äî –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —é–∑–µ—Ä—É.

–ü–µ—Ä–µ–¥–∞—á–∞ –ø—è—Ç—é–Ω–∏

–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ t.me/bot?start={user_id}. –¢–µ–∫—Å—Ç –≤–∫–ª—é—á–∞–µ—Ç –ø—Ä–æ–π–¥–µ–Ω–Ω—É—é –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –∏ —Ñ–ª–∞–≥–∏ —Å—Ç—Ä–∞–Ω –≤ —Ü–µ–ø–æ—á–∫–µ –ø—Ä–µ–¥–∫–æ–≤.

–õ–∏–¥–µ—Ä–±–æ—Ä–¥—ã

–¢–æ–ø –ø–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ –≤–µ—Ç–∫–∏, —Ç–æ–ø –ø–æ –ø–æ–ª—É—á–µ–Ω–Ω—ã–º –ø—è—Ç—é–Ω—è–º, —Ç–æ–ø –º–µ—Ü–µ–Ω–∞—Ç–æ–≤. ADMIN_ID –∏—Å–∫–ª—é—á—ë–Ω. –ö—ç—à 30 –º–∏–Ω. –ò–∫–æ–Ω–∫–∏ —É—Ä–æ–≤–Ω–µ–π —Ä—è–¥–æ–º —Å –∏–º–µ–Ω–∞–º–∏.

–î–æ–Ω–∞—Ç—ã

Telegram Stars (XTR). –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤ total_donated. Badge –≤ –ø—Ä–æ—Ñ–∏–ª–µ.

–ú–µ–≥–∞-–∫–≤–µ—Å—Ç

–ö—Ä—É–≥–æ—Å–≤–µ—Ç–∫–∞ —Å –≤–æ–∑–≤—Ä–∞—Ç–æ–º: –ø—è—Ç—é–Ω—è –ø—Ä–æ—à–ª–∞ 40075 –∫–º –ò –≤–µ—Ä–Ω—É–ª–∞—Å—å –≤ —Ä–∞–¥–∏—É—Å 500 –∫–º –æ—Ç —Å—Ç–∞—Ä—Ç–∞. –ì–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ, badge —É—á–∞—Å—Ç–Ω–∏–∫–∞–º.

–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

–¢–æ–ª—å–∫–æ ADMIN_ID. –ö–æ–º–∞–Ω–¥—ã: /broadcast ‚Äî —Ä–∞—Å—Å—ã–ª–∫–∞ 30 msg/sec —á–µ—Ä–µ–∑ TaskIQ, —Å—Ç–µ–π—Ç –≤ Redis; /broadcast_stop ‚Äî –ø–∞—É–∑–∞; /maintenance on|off ‚Äî —Ä–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è; /stats ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞.

–õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

10 —è–∑—ã–∫–æ–≤: ru, en, es, pt, zh, hi, ko, ja, ar, tr. Fallback –Ω–∞ en. –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ language_code.

Redis-–∫–ª—é—á–∏

cache:leaderboard:, cache:progress:global, where:{user_id}:, ancestors:{user_id}, broadcast:{id}:*, maintenance:enabled, throttle:{user_id}:{action}.

–§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏

update_where_cache ‚Äî –ø–µ—Ä–µ—Å—á—ë—Ç Tier1/2 –∫–∞–∂–¥—ã–π —á–∞—Å. process_where_queue ‚Äî –æ–±—Ä–∞–±–æ—Ç–∫–∞ Tier3. daily_report ‚Äî –µ–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Å–≤–æ–¥–∫–∞. geocode_queue ‚Äî –≥–µ–æ–∫–æ–¥–∏–Ω–≥ 1 req/1.1sec.

–ê–Ω—Ç–∏—Ñ–ª—É–¥

/start ‚Äî 10 —Å–µ–∫, –≥–µ–æ–ª–æ–∫–∞—Ü–∏—è ‚Äî 60 —Å–µ–∫, /share ‚Äî 5 —Å–µ–∫. Middleware –ª–æ–≤–∏—Ç TelegramForbiddenError ‚Üí is_blocked=TRUE.
–ü—Ä–æ–¥–æ–ª–∂–∞—é –¢–ó.



–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–°–æ–±—ã—Ç–∏–π–Ω—ã–µ –ø—É—à–∏ –ø–µ—Ä–≤—ã–µ 6 —É—Ä–æ–≤–Ω–µ–π –≥–ª—É–±–∏–Ω—ã –≤–µ—Ç–∫–∏: ¬´–ò–º—è –∏–∑ –ì–æ—Ä–æ–¥–∞ –ø—Ä–∏–Ω—è–ª –ø—è—Ç—é–Ω—é¬ª (1 —É—Ä–æ–≤–µ–Ω—å), ¬´–ò–º—è ‚Äî –ø–æ—Ç–æ–º–æ–∫ N —É—Ä–æ–≤–Ω—è¬ª (2-6). Daily Report: —Ä–æ—Å—Ç –≤–µ—Ç–∫–∏, –Ω–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω—ã, –ø—Ä–æ–≥—Ä–µ—Å—Å. –í –∫–∞–∂–¥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å—å ¬´–û—Ç–∫–ª—é—á–∏—Ç—å: /stopnews¬ª.

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

pyatyunya/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ main.py, config.py
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/ (maintenance, throttling, i18n)
‚îÇ   ‚îú‚îÄ‚îÄ handlers/ (start, where, share, donate, leaderboards, settings, admin)
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/ (reply, inline)
‚îÇ   ‚îú‚îÄ‚îÄ services/ (tree, geo, progress)
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îú‚îÄ‚îÄ db/ (models, session, queries)
‚îú‚îÄ‚îÄ tasks/ (broker, broadcast, geocode, daily_report, where_cache)
‚îú‚îÄ‚îÄ i18n/ (10 yaml-—Ñ–∞–π–ª–æ–≤)
‚îú‚îÄ‚îÄ alembic/
‚îú‚îÄ‚îÄ tests/
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ .env.example


ENV-–ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

BOT_TOKEN, ADMIN_ID, DATABASE_URL (postgresql+asyncpg://), REDIS_URL, MAINTENANCE_MODE=False, SENTRY_DSN, GEOCODE_USER_AGENT.

–†–∞—Å—á—ë—Ç –≤–µ—Ç–æ–∫

–¶–µ–ø–æ—á–∫–∞ –ø—Ä–µ–¥–∫–æ–≤: 6 —É—Ä–æ–≤–Ω–µ–π –≤–≤–µ—Ä—Ö –ø–æ parent_id. –°–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è –≤–µ—Ç–∫–∞ –≤–Ω–∏–∑: —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π CTE, –ª–∏–º–∏—Ç 50 —É—Ä–æ–≤–Ω–µ–π, —Å—É–º–º–∞ distance_to_parent. –û–±—â–µ–µ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π: —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π CTE, COUNT. –í—Å—ë –∫—ç—à–∏—Ä—É–µ—Ç—Å—è 15-60 –º–∏–Ω.

–ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

–í—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –ø–æ –∏–Ω–≤–∞–π—Ç—É. ADMIN —Å–∫—Ä—ã—Ç –∏–∑ —Ç–æ–ø–æ–≤. –ò–Ω–¥–µ–∫—Å—ã + Redis + async. 100k+ —é–∑–µ—Ä–æ–≤ –Ω–∞ Docker Compose. 10 —è–∑—ã–∫–æ–≤. Graceful shutdown. Sentry + Loguru.
