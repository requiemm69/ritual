# ritual
Digital Bond Ritual
–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ: Telegram-–±–æ—Ç ¬´–ü—è—Ç—é–Ω—è¬ª

–§–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è



1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

–ò–¥–µ—è: –°–æ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–æ–µ–∫—Ç ¬´–ú–∏—Ä–Ω–∞—è —ç—Å—Ç–∞—Ñ–µ—Ç–∞ —Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏–π¬ª. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥–∞—é—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é ¬´–ø—è—Ç—é–Ω—é¬ª –¥—Ä—É–≥ –¥—Ä—É–≥—É, —Å–æ–∑–¥–∞–≤–∞—è –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ —Å–≤—è–∑–µ–π. –ë–æ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –º–µ–∂–¥—É —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ –∏ –≤–∏–∑—É–∞–ª–∏–∑–∏—Ä—É–µ—Ç, –∫–∞–∫ –¥–∞–ª–µ–∫–æ ¬´–¥–æ–ª–µ—Ç–µ–ª–∞¬ª –ø—è—Ç—é–Ω—è.

–ú–∏—Å—Å–∏—è: –û–±—ä–µ–¥–∏–Ω–∏—Ç—å –ª—é–¥–µ–π —Å–æ –≤—Å–µ–≥–æ –º–∏—Ä–∞ –≤ –æ–¥–Ω—É —Ü–µ–ø–æ—á–∫—É. –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø—Ä–æ–π—Ç–∏ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ —ç–∫–≤–∞—Ç–æ—Ä–∞ (40 075 –∫–º) –∏ –¥–∞–ª—å—à–µ.

–ú–æ–¥–µ–ª—å: –ù–µ–∫–æ–º–º–µ—Ä—á–µ—Å–∫–∏–π –ø—Ä–æ–µ–∫—Ç. –î–æ–Ω–∞—Ç—ã (Telegram Stars) ‚Äî —Å–∏–º–≤–æ–ª–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –Ω–µ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è.



2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫




–ö–æ–º–ø–æ–Ω–µ–Ω—Ç
–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è





–Ø–∑—ã–∫
Python 3.11+



–§—Ä–µ–π–º–≤–æ—Ä–∫ –±–æ—Ç–∞
aiogram 3.x



ORM
SQLAlchemy 2.0 (async)



–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
PostgreSQL



–ö—ç—à –∏ –±—Ä–æ–∫–µ—Ä
Redis



–û—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞—á
TaskIQ



–ú–∏–≥—Ä–∞—Ü–∏–∏
Alembic



–ì–µ–æ–∫–æ–¥–∏–Ω–≥
Geopy + Nominatim (fallback –Ω–∞ LocationIQ)



–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
Loguru



–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫
Sentry



–î–µ–ø–ª–æ–π
Docker Compose –Ω–∞ VPS






3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

pyatyunya/
‚îú‚îÄ‚îÄ bot/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main.py
‚îÇ   ‚îú‚îÄ‚îÄ config.py
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ maintenance.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ throttling.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ i18n.py
‚îÇ   ‚îú‚îÄ‚îÄ handlers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ start.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ profile.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ share.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ donate.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ leaderboards.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ settings.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ admin.py
‚îÇ   ‚îú‚îÄ‚îÄ keyboards/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ reply.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ inline.py
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ tree.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geo.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ progress.py
‚îÇ   ‚îî‚îÄ‚îÄ utils/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îî‚îÄ‚îÄ helpers.py
‚îú‚îÄ‚îÄ db/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ models.py
‚îÇ   ‚îú‚îÄ‚îÄ session.py
‚îÇ   ‚îî‚îÄ‚îÄ queries.py
‚îú‚îÄ‚îÄ tasks/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ broker.py
‚îÇ   ‚îú‚îÄ‚îÄ broadcast.py
‚îÇ   ‚îú‚îÄ‚îÄ geocode.py
‚îÇ   ‚îî‚îÄ‚îÄ daily_report.py
‚îú‚îÄ‚îÄ i18n/
‚îÇ   ‚îú‚îÄ‚îÄ ru.yaml
‚îÇ   ‚îú‚îÄ‚îÄ en.yaml
‚îÇ   ‚îú‚îÄ‚îÄ es.yaml
‚îÇ   ‚îú‚îÄ‚îÄ pt.yaml
‚îÇ   ‚îú‚îÄ‚îÄ zh.yaml
‚îÇ   ‚îú‚îÄ‚îÄ hi.yaml
‚îÇ   ‚îú‚îÄ‚îÄ ko.yaml
‚îÇ   ‚îú‚îÄ‚îÄ ja.yaml
‚îÇ   ‚îú‚îÄ‚îÄ ar.yaml
‚îÇ   ‚îî‚îÄ‚îÄ tr.yaml
‚îú‚îÄ‚îÄ alembic/
‚îÇ   ‚îú‚îÄ‚îÄ env.py
‚îÇ   ‚îî‚îÄ‚îÄ versions/
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ test_tree.py
‚îÇ   ‚îî‚îÄ‚îÄ test_geo.py
‚îú‚îÄ‚îÄ alembic.ini
‚îú‚îÄ‚îÄ pyproject.toml
‚îú‚îÄ‚îÄ Dockerfile
‚îú‚îÄ‚îÄ docker-compose.yml
‚îî‚îÄ‚îÄ .env.example




4. –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

–¢–∞–±–ª–∏—Ü–∞ users

CREATE TABLE users (
    id BIGINT PRIMARY KEY,              -- Telegram ID
    username VARCHAR(64),
    first_name VARCHAR(128),
    language_code VARCHAR(5) DEFAULT 'en',
    parent_id BIGINT REFERENCES users(id),
    distance_to_parent FLOAT DEFAULT 0, -- –∫–º –¥–æ —Ä–æ–¥–∏—Ç–µ–ª—è
    lat FLOAT,
    lon FLOAT,
    country_code VARCHAR(3),
    total_donated INTEGER DEFAULT 0,
    notifications_enabled BOOLEAN DEFAULT TRUE,
    is_blocked BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX idx_users_parent ON users(parent_id);
CREATE INDEX idx_users_country ON users(country_code);
CREATE INDEX idx_users_notifications ON users(notifications_enabled);
CREATE INDEX idx_users_not_blocked ON users(is_blocked) WHERE is_blocked = FALSE;


–ü—Ä–∏–Ω—Ü–∏–ø—ã


–û–¥–∏–Ω —é–∑–µ—Ä = –æ–¥–∏–Ω —Ä–æ–¥–∏—Ç–µ–ª—å –Ω–∞–≤—Å–µ–≥–¥–∞ (–¥–µ—Ä–µ–≤–æ, –Ω–µ –≥—Ä–∞—Ñ)
Telegram ID –∫–∞–∫ Primary Key (BigInt)
–û—Ç–¥–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ links –Ω–µ –Ω—É–∂–Ω–∞
–û—Å–∏—Ä–æ—Ç–µ–≤—à–∏–µ –≤–µ—Ç–∫–∏ (—É–¥–∞–ª—ë–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã) –æ—Å—Ç–∞—é—Ç—Å—è –∫–∞–∫ –µ—Å—Ç—å




5. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ (Redis)

–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª—é—á–µ–π

cache:leaderboard:distance      -- —Ç–æ–ø –ø–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
cache:leaderboard:thanks        -- —Ç–æ–ø –ø–æ –¥–æ–Ω–∞—Ç–∞–º
cache:progress:global           -- –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å
user:{id}:profile_cache         -- –∫—ç—à –ø—Ä–æ—Ñ–∏–ª—è —é–∑–µ—Ä–∞
broadcast:{id}:offset           -- –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞—Å—Å—ã–ª–∫–∏
broadcast:{id}:status           -- —Å—Ç–∞—Ç—É—Å: running/paused/done
maintenance:enabled             -- —Ä–µ–∂–∏–º –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è


TTL




–ö–ª—é—á
TTL





–õ–∏–¥–µ—Ä–±–æ—Ä–¥—ã
30 –º–∏–Ω—É—Ç



–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å
1 —á–∞—Å



–ü—Ä–æ—Ñ–∏–ª—å —é–∑–µ—Ä–∞
15 –º–∏–Ω—É—Ç



–ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ TTL, –Ω–µ –ø–æ —Å–æ–±—ã—Ç–∏—è–º.



6. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

# Telegram
BOT_TOKEN=
ADMIN_ID=

# Database
DATABASE_URL=postgresql+asyncpg://user:pass@localhost:5432/pyatyunya

# Redis
REDIS_URL=redis://localhost:6379/0

# App
MAINTENANCE_MODE=False

# Sentry
SENTRY_DSN=

# Geocoding
GEOCODE_USER_AGENT=pyatyunya-bot
# LOCATIONIQ_API_KEY=  # –¥–ª—è –ø–ª–∞—Ç–Ω–æ–≥–æ API




7. –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —è–∑—ã–∫–∏




–ö–æ–¥
–Ø–∑—ã–∫





ru
–†—É—Å—Å–∫–∏–π



en
English



es
Espa√±ol



pt
Portugu√™s



zh
‰∏≠Êñá (—É–ø—Ä–æ—â—ë–Ω–Ω—ã–π)



hi
‡§π‡§ø‡§®‡•ç‡§¶‡•Ä



ko
ÌïúÍµ≠Ïñ¥



ja
Êó•Êú¨Ë™û



ar
ÿßŸÑÿπÿ±ÿ®Ÿäÿ©



tr
T√ºrk√ße




–õ–æ–≥–∏–∫–∞


–ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ language_code –∏–∑ Telegram
–ï—Å–ª–∏ —è–∑—ã–∫ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è ‚Äî fallback –Ω–∞ en
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å —è–∑—ã–∫ —á–µ—Ä–µ–∑ –º–µ–Ω—é
RTL (–∞—Ä–∞–±—Å–∫–∏–π) –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è Telegram –Ω–∞—Ç–∏–≤–Ω–æ




8. –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

8.1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∏ –¥–æ—Å—Ç—É–ø

–í—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é:


/start –±–µ–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –æ—Ç–∫–∞–∑: ¬´–í—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –ø—è—Ç—é–Ω—é –≤ –Ω–∞—à–µ–º —Å–æ–æ–±—â–µ—Å—Ç–≤–µ: [—Å—Å—ã–ª–∫–∞]¬ª
–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: ADMIN_ID –º–æ–∂–µ—Ç –≤–æ–π—Ç–∏ –±–µ–∑ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è (—Å–æ–∑–¥–∞—ë—Ç –∫–æ—Ä–µ–Ω—å –¥–µ—Ä–µ–≤–∞)


–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–æ–π:


/start {referrer_id} ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ referrer —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
–°–æ–∑–¥–∞—ë–º —é–∑–µ—Ä–∞ –≤ –ë–î (–±–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é (–∫–Ω–æ–ø–∫–∞ + —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –≥–æ—Ä–æ–¥–∞)
–ü–æ–ª—É—á–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã ‚Üí –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞
–°–æ—Ö—Ä–∞–Ω—è–µ–º lat, lon, country_code, —Å—á–∏—Ç–∞–µ–º distance_to_parent


–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ —É–∫–∞–∑–∞–Ω–∞:


–Æ–∑–µ—Ä –ø–æ–ª—É—á–∞–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
–í–∏–¥–∏—Ç –ø—Ä–æ—Ñ–∏–ª—å, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –ø—è—Ç—é–Ω—é
distance_to_parent = 0
–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —Ä–∞–∑ –≤ –¥–µ–Ω—å: ¬´–£–∫–∞–∂–∏ –≥–æ—Ä–æ–¥, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—è—Ç—é–Ω—é¬ª


–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ: —Ñ–æ—Ä–º—É–ª–∞ –ì–∞–≤–µ—Ä—Å–∏–Ω—É—Å–∞ –º–µ–∂–¥—É –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ parent –∏ child.

8.2. –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (Reply Keyboard)

[‚úã –ü–µ—Ä–µ–¥–∞—Ç—å –ü—è—Ç—é–Ω—é]  [üë§ –ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å]
[üèÜ –õ–∏–¥–µ—Ä–±–æ—Ä–¥—ã]      [‚≠ê –ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å]
[üåê –Ø–∑—ã–∫ / Language]


–í—Å–µ –∫–Ω–æ–ø–∫–∏ –ª–æ–∫–∞–ª–∏–∑–æ–≤–∞–Ω—ã.

8.3. –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å

–û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç:


–¶–µ–ø–æ—á–∫–∞ –ø—Ä–µ–¥–∫–æ–≤ (6 —á–µ–ª–æ–≤–µ–∫ –≤–≤–µ—Ä—Ö): ¬´–ò–≤–∞–Ω ‚Üí –ú–∞—Ä–∏—è ‚Üí –û–ª–µ–≥ ‚Üí ‚Ä¶¬ª
–î–∏—Å—Ç–∞–Ω—Ü–∏—è —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π –≤–µ—Ç–∫–∏ –≤–Ω–∏–∑ (–∫–º)
–û–±—â–µ–µ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Å–µ –ø–æ—Ç–æ–º–∫–∏)
–°—É–º–º–∞ –¥–æ–Ω–∞—Ç–æ–≤ (Stars)
Badge ¬´–õ–µ–≥–µ–Ω–¥–∞-—Å–ø–æ–Ω—Å–æ—Ä¬ª (–µ—Å–ª–∏ –¥–æ–Ω–∞—Ç–∏–ª)
–°—Ç–∞—Ç—É—Å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π + –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä


8.4. –ü–µ—Ä–µ–¥–∞—á–∞ –ø—è—Ç—é–Ω–∏

–ö–æ–º–∞–Ω–¥–∞ /share –∏–ª–∏ –∫–Ω–æ–ø–∫–∞ –º–µ–Ω—é:


–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞: t.me/bot?start={user_id}
–ö—Ä–∞—Å–∏–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
–ö–Ω–æ–ø–∫–∞ ¬´–ü–µ—Ä–µ–¥–∞—Ç—å –¥—Ä—É–≥—É¬ª —á–µ—Ä–µ–∑ t.me/share/url


8.5. –î–æ–Ω–∞—Ç—ã (Telegram Stars)


–ö–Ω–æ–ø–∫–∞ ¬´–ü–æ–¥–¥–µ—Ä–∂–∞—Ç—å¬ª ‚Üí –≤–≤–æ–¥ —Å—É–º–º—ã ‚Üí –∏–Ω–≤–æ–π—Å –≤ XTR
–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ –≤ total_donated
Badge ¬´–õ–µ–≥–µ–Ω–¥–∞-—Å–ø–æ–Ω—Å–æ—Ä¬ª –≤ –ø—Ä–æ—Ñ–∏–ª–µ


8.6. –õ–∏–¥–µ—Ä–±–æ—Ä–¥—ã

–¢–æ–ø –ø–æ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏ (/top_distance):


10 —é–∑–µ—Ä–æ–≤ —Å —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π –≤–µ—Ç–∫–æ–π
–§–æ—Ä–º–∞—Ç: ¬´1. –ò–º—è üá∑üá∫ ‚Äî 1234 –∫–º¬ª


–¢–æ–ø –ø–æ –¥–æ–Ω–∞—Ç–∞–º (/top_thanks):


10 —é–∑–µ—Ä–æ–≤ —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π —Å—É–º–º–æ–π Stars
–§–æ—Ä–º–∞—Ç: ¬´1. –ò–º—è üá∑üá∫ ‚Äî 500 ‚≠ê¬ª


–ü—Ä–∞–≤–∏–ª–∞:


ADMIN_ID –∏—Å–∫–ª—é—á—ë–Ω –∏–∑ –æ–±–æ–∏—Ö —Ç–æ–ø–æ–≤ (WHERE id != ADMIN_ID)
–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ 30 –º–∏–Ω—É—Ç


8.7. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:


/stopnews ‚Äî –≤—ã–∫–ª—é—á–∏—Ç—å
/startnews ‚Äî –≤–∫–ª—é—á–∏—Ç—å
–ö–Ω–æ–ø–∫–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ


–¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:


–°–æ–±—ã—Ç–∏–π–Ω—ã–µ –ø—É—à–∏ (–ø–µ—Ä–≤—ã–µ 6 —É—Ä–æ–≤–Ω–µ–π –≥–ª—É–±–∏–Ω—ã):


–£—Ä–æ–≤–µ–Ω—å 1: ¬´–ú–∏—à–∞ –∏–∑ –ú–æ—Å–∫–≤—ã –ø—Ä–∏–Ω—è–ª —Ç–≤–æ—é –ø—è—Ç—é–Ω—é!¬ª
–£—Ä–æ–≤–Ω–∏ 2-6: ¬´–û–ª–µ–≥ –∏–∑ –Ø–∫—É—Ç–∏–∏ ‚Äî —Ç–≤–æ–π –ø–æ—Ç–æ–º–æ–∫ 3-–≥–æ —É—Ä–æ–≤–Ω—è!¬ª
–ü–æ—Å–ª–µ 6-–≥–æ —É—Ä–æ–≤–Ω—è ‚Äî —Ç–∏—à–∏–Ω–∞


Daily Report (—Ä–∞–∑ –≤ —Å—É—Ç–∫–∏):


–¢–≤–æ—è –≤–µ—Ç–∫–∞ –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ X —á–µ–ª–æ–≤–µ–∫
–ù–æ–≤—ã–µ —Å—Ç—Ä–∞–Ω—ã –≤ —Å–µ—Ç–∏
–ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å



–í–∞–∂–Ω–æ: –í –∫–∞–∂–¥–æ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ ‚Äî –ø–æ–¥–ø–∏—Å—å ¬´–û—Ç–∫–ª—é—á–∏—Ç—å: /stopnews¬ª

8.8. –ì–ª–æ–±–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å

–¶–µ–ª—å: 40 075 –∫–º (–¥–ª–∏–Ω–∞ —ç–∫–≤–∞—Ç–æ—Ä–∞)

–†–∞—Å—á—ë—Ç: SELECT SUM(distance_to_parent) FROM users

–û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ:

üåç –ú–∏—Å—Å–∏—è: –ö—Ä—É–≥–æ—Å–≤–µ—Ç–∫–∞!
–ú—ã –≤–º–µ—Å—Ç–µ: 12 400 / 40 075 –∫–º
[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 31%


–ü—Ä–∏ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–∏:


–ì–ª–æ–±–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤—Å–µ–º
–ù–∞–¥–ø–∏—Å—å ¬´–ö—Ä—É–≥ 1 –∑–∞–≤–µ—Ä—à—ë–Ω!¬ª
–ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è, —Å—á—ë—Ç—á–∏–∫ –∫—Ä—É–≥–æ–≤ +1
–ù–æ–≤–∞—è —Ü–µ–ª—å: —Å–ª–µ–¥—É—é—â–∏–π –∫—Ä—É–≥


8.9. –°–º–µ–Ω–∞ —è–∑—ã–∫–∞


–ö–Ω–æ–ø–∫–∞ ¬´–Ø–∑—ã–∫ / Language¬ª –≤ –º–µ–Ω—é
–ò–Ω–ª–∞–π–Ω-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å —Ñ–ª–∞–≥–∞–º–∏: üá∑üá∫ üá∫üá∏ üá™üá∏ üáßüá∑ üá®üá≥ üáÆüá≥ üá∞üá∑ üáØüáµ üá∏üá¶ üáπüá∑
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ language_code




9. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

–î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è ADMIN_ID. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –Ω–∞—á–∞–ª–µ –∫–∞–∂–¥–æ–≥–æ —Ö–µ–Ω–¥–ª–µ—Ä–∞.

–ö–æ–º–∞–Ω–¥—ã

/broadcast <—Ç–µ–∫—Å—Ç>


–†–∞—Å—Å—ã–ª–∫–∞ –≤—Å–µ–º —Å notifications_enabled = TRUE –∏ is_blocked = FALSE
–ß–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å TaskIQ, 30 —Å–æ–æ–±—â–µ–Ω–∏–π/—Å–µ–∫
–°—Ç–µ–π—Ç –≤ Redis: broadcast:{id}:offset, broadcast:{id}:status
–ü—Ä–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–µ ‚Äî –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏


/broadcast_stop


–°—Ç–∞–≤–∏—Ç —Å—Ç–∞—Ç—É—Å paused
–†–∞—Å—Å—ã–ª–∫–∞ –ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç—Å—è


/maintenance [on|off]


–£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–ª–∞–≥ –≤ Redis
–ï—Å–ª–∏ on ‚Äî –≤—Å–µ –Ω–µ-–∞–¥–º–∏–Ω—Å–∫–∏–µ —Ö–µ–Ω–¥–ª–µ—Ä—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç: ¬´üèó –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã. –í–µ—Ä–Ω—ë–º—Å—è —á–µ—Ä–µ–∑ –ø–∞—Ä—É —á–∞—Å–æ–≤!¬ª


/stats


–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω
–û–±—â–∞—è –¥–∏—Å—Ç–∞–Ω—Ü–∏—è
–û–±—â–∞—è —Å—É–º–º–∞ –¥–æ–Ω–∞—Ç–æ–≤




10. –†–∞—Å—á—ë—Ç –≤–µ—Ç–æ–∫ (services/tree.py)

–¶–µ–ø–æ—á–∫–∞ –ø—Ä–µ–¥–∫–æ–≤ (–≤–≤–µ—Ä—Ö)


6 —É—Ä–æ–≤–Ω–µ–π –≤–≤–µ—Ä—Ö –æ—Ç —Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞
–ü—Ä–æ—Å—Ç–æ–π —Ü–∏–∫–ª –ø–æ parent_id


–°–∞–º–∞—è –¥–ª–∏–Ω–Ω–∞—è –≤–µ—Ç–∫–∞ (–≤–Ω–∏–∑)


–†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π CTE —Å –ª–∏–º–∏—Ç–æ–º 50 —É—Ä–æ–≤–Ω–µ–π
–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—É–º–º—É distance_to_parent –ø–æ —Å–∞–º–æ–π –¥–ª–∏–Ω–Ω–æ–π –≤–µ—Ç–∫–µ
Realtime —Ä–∞—Å—á—ë—Ç, –±–µ–∑ —Ñ–æ–Ω–æ–≤–æ–≥–æ –ø–µ—Ä–µ—Å—á—ë—Ç–∞


–û–±—â–µ–µ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π


–†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π CTE: –≤—Å–µ –ø–æ—Ç–æ–º–∫–∏
–õ–∏–º–∏—Ç 50 —É—Ä–æ–≤–Ω–µ–π
Realtime —Ä–∞—Å—á

–ü—Ä–æ–¥–æ–ª–∂–∞—é –¢–ó —Å –º–µ—Å—Ç–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.



–û–±—â–µ–µ —á–∏—Å–ª–æ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª–µ–π


–†–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π CTE: –≤—Å–µ –ø–æ—Ç–æ–º–∫–∏
–õ–∏–º–∏—Ç 50 —É—Ä–æ–≤–Ω–µ–π
Realtime —Ä–∞—Å—á—ë—Ç, –∫—ç—à –ø—Ä–æ—Ñ–∏–ª—è 15 –º–∏–Ω—É—Ç




11. –ì–µ–æ–∫–æ–¥–∏–Ω–≥ (services/geo.py)

–ò—Å—Ç–æ—á–Ω–∏–∫


Geopy + Nominatim (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π)
User-Agent: pyatyunya-bot
–ü—Ä–∏ —Ä–æ—Å—Ç–µ ‚Äî –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ LocationIQ (–ø–ª–∞—Ç–Ω—ã–π)


–õ–æ–≥–∏–∫–∞


–ì–µ–æ–∫–æ–¥–∏–Ω–≥ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å TaskIQ
–ó–∞–¥–µ—Ä–∂–∫–∞ 1.1 —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏ (–ª–∏–º–∏—Ç Nominatim)
–†–µ–∑—É–ª—å—Ç–∞—Ç: lat, lon, country_code
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å —é–∑–µ—Ä–∞


Haversine

from math import radians, sin, cos, sqrt, atan2

def haversine(lat1: float, lon1: float, lat2: float, lon2: float) -> float:
    R = 6371  # —Ä–∞–¥–∏—É—Å –ó–µ–º–ª–∏ –≤ –∫–º
    
    lat1, lon1, lat2, lon2 = map(radians, [lat1, lon1, lat2, lon2])
    dlat = lat2 - lat1
    dlon = lon2 - lon1
    
    a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2
    c = 2 * atan2(sqrt(a), sqrt(1-a))
    
    return R * c




12. –ó–∞—â–∏—Ç–∞ –∏ –ª–∏–º–∏—Ç—ã

–ê–Ω—Ç–∏—Ñ–ª—É–¥ (throttling)




–î–µ–π—Å—Ç–≤–∏–µ
–õ–∏–º–∏—Ç





/start
1 —Ä–∞–∑ –≤ 10 —Å–µ–∫



–û—Ç–ø—Ä–∞–≤–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏
1 —Ä–∞–∑ –≤ 60 —Å–µ–∫



/share
1 —Ä–∞–∑ –≤ 5 —Å–µ–∫



/donate
1 —Ä–∞–∑ –≤ 10 —Å–µ–∫




–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫


Middleware –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç TelegramForbiddenError
–ï—Å–ª–∏ —é–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞ ‚Äî —Å—Ç–∞–≤–∏–º is_blocked = TRUE
–ò—Å–∫–ª—é—á–∞–µ–º –∏–∑ —Ä–∞—Å—Å—ã–ª–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏


–ù–∞–∫—Ä—É—Ç–∫–∞


1 Telegram ID = 1 —É–∑–µ–ª –≤ –¥–µ—Ä–µ–≤–µ
–ü–µ—Ä–µ–ø—Ä–∏–≤—è–∑–∫–∞ –∫ –¥—Ä—É–≥–æ–º—É —Ä–æ–¥–∏—Ç–µ–ª—é –Ω–µ–≤–æ–∑–º–æ–∂–Ω–∞




13. –§–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ (TaskIQ)

broadcast.py


–†–∞—Å—Å—ã–ª–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —á–∞–Ω–∫–∞–º–∏
30 msg/sec —Å asyncio.sleep(1/30)
–°—Ç–µ–π—Ç –≤ Redis –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∞


geocode.py


–û—á–µ—Ä–µ–¥—å –≥–µ–æ–∫–æ–¥–∏–Ω–≥–∞
1 –∑–∞–ø—Ä–æ—Å –≤ 1.1 —Å–µ–∫
–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞


daily_report.py


–ó–∞–ø—É—Å–∫ —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ (APScheduler –∏–ª–∏ TaskIQ scheduled)
–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á—ë—Ç–∞
–†–∞—Å—Å—ã–ª–∫–∞ —á–µ—Ä–µ–∑ –æ—á–µ—Ä–µ–¥—å broadcast




14. Middleware

maintenance.py

async def maintenance_middleware(handler, event, data):
    if await redis.get("maintenance:enabled") == "1":
        if event.from_user.id != ADMIN_ID:
            await event.answer("üèó –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã...")
            return
    return await handler(event, data)


throttling.py


–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –ø–æ Redis –∫–ª—é—á–∞–º
throttle:{user_id}:{action} —Å TTL


i18n.py


–ü–æ–ª—É—á–µ–Ω–∏–µ language_code –∏–∑ –ë–î
–ü–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤ data["i18n"] –¥–ª—è —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤




15. Graceful shutdown

async def on_shutdown(dispatcher):
    # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
    await db_session.close()
    await redis.close()
    # –ñ–¥—ë–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á
    await taskiq_broker.shutdown()




16. –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏




–ö–∞—Ç–µ–≥–æ—Ä–∏—è
–ö—Ä–∏—Ç–µ—Ä–∏–π





–î–æ—Å—Ç—É–ø
–í—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –ø–æ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ



–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
ADMIN_ID —Å–∫—Ä—ã—Ç –∏–∑ —Ç–æ–ø–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ –≤—Å–µ—Ö –∞–¥–º–∏–Ω-—Ö–µ–Ω–¥–ª–µ—Ä–∞—Ö



–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
–ò–Ω–¥–µ–∫—Å—ã + Redis –∫—ç—à + async –≤–µ–∑–¥–µ



–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å
100k+ —é–∑–µ—Ä–æ–≤ –Ω–∞ Docker Compose



UX
10 —è–∑—ã–∫–æ–≤, –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä, –ø–æ–Ω—è—Ç–Ω–æ–µ –º–µ–Ω—é



–£—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å
Graceful shutdown, –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–æ–∫



–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
Sentry + Loguru






17. –†–æ–∞–¥–º–∞–ø —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

–§–∞–∑–∞ 1 ‚Äî MVP:


models.py + Alembic –º–∏–≥—Ä–∞—Ü–∏–∏
config.py + main.py (—Å–∫–µ–ª–µ—Ç)
services/tree.py (—Ä–∞—Å—á—ë—Ç –≤–µ—Ç–æ–∫)
services/geo.py (Haversine + –≥–µ–æ–∫–æ–¥–∏–Ω–≥)
handlers/start.py (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
handlers/profile.py
handlers/share.py
keyboards/
i18n/ (–º–∏–Ω–∏–º—É–º ru + en)
middlewares/


–§–∞–∑–∞ 2 ‚Äî –ü–æ–ª–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª:


handlers/donate.py
handlers/leaderboards.py
handlers/admin.py
tasks/ (broadcast, daily_report)
–û—Å—Ç–∞–ª—å–Ω—ã–µ —è–∑—ã–∫–∏


–§–∞–∑–∞ 3 ‚Äî –ü—Ä–æ–¥–∞–∫—à–µ–Ω:


Docker + docker-compose
Sentry –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
–¢–µ—Å—Ç—ã
–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –¥–µ–ø–ª–æ—è




–≠—Ç–æ –ø–æ–ª–Ω–æ–µ –¢–ó. –°–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å–∫–∏–Ω–µ—à—å –º–Ω–µ –≤ –Ω–∞—á–∞–ª–µ –¥–∏–∞–ª–æ–≥–∞, –∏ —è —Å—Ä–∞–∑—É –≤–æ–π–¥—É –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç.

–ù–∞—á–∏–Ω–∞–µ–º —Å –∫–æ–¥–∞?


db/models.py ‚Äî SQLAlchemy –º–æ–¥–µ–ª–∏
Alembic init ‚Äî –Ω–∞—á–∞–ª—å–Ω–∞—è –º–∏–≥—Ä–∞—Ü–∏—è
bot/config.py ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

